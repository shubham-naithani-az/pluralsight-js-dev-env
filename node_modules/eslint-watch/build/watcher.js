"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = watcher;

var _chokidar = _interopRequireDefault(require("chokidar"));

var _eslint = _interopRequireDefault(require("eslint"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _settings = _interopRequireDefault(require("./settings"));

var _logger = _interopRequireDefault(require("./logger"));

var _clearTerminal = _interopRequireDefault(require("./formatters/helpers/clear-terminal.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const logger = (0, _logger.default)('watcher');
logger.debug('Loaded');
const events = {
  change: 'change'
};
const chokidarOptions = {
  ignored: /\.git|node_modules|bower_components/
};
const cliOptionProperties = ['config', 'eslintrc', 'ext', 'parser', 'cache', 'cacheLocation', 'ignore', 'ignorePath', 'ignorePattern', 'fix', 'parserOptions', 'global'];
const cliOptionMap = {
  config: 'configFile',
  eslintrc: 'useEslintrc',
  ext: 'extensions',
  cacheFile: 'cacheLocation'
};

function filterWarnings(results) {
  return _lodash.default.reduce(results, (curr, result) => {
    if (result.warningCount) {
      let newResult = _lodash.default.omit(result, 'messages');

      newResult.messages = _lodash.default.filter(result.messages, m => m.severity > 1);
      curr.push(newResult);
      return curr;
    }

    curr.push(result);
    return curr;
  }, []);
}

function requireFormatter(formatterPath) {
  try {
    return require(formatterPath);
  } catch (ex) {
    ex.message = `There was a problem loading formatter: ${formatterPath}\nError: ${ex.message}`;
    throw ex;
  }
}

function getFormatter(cli, formatter) {
  const pathToFormatterSpecified = formatter.includes('\\');
  const isSimpleFormatter = formatter.includes('simple');
  const formatterPath = formatter.replace(/\\/g, '/');

  if (isSimpleFormatter) {
    logger.debug(`Formatter local: ${formatter}`);
    return requireFormatter(`./formatters/${formatterPath}`);
  } else if (pathToFormatterSpecified) {
    const cwd = process.cwd();
    logger.debug('Formatter user:', formatterPath);

    const location = _path.default.resolve(cwd, formatterPath);

    return requireFormatter(location);
  }

  logger.debug(`Formatter eslint: ${formatter}`);
  return cli.getFormatter(formatter);
} ///https://github.com/eslint/eslint/blob/233440e524aa41545b66b2c3c7ca26fe790e32e0/tests/lib/cli-engine.js#L105-L107


function watcher(options) {
  const cliOptions = (0, _lodash.default)(options).pick(cliOptionProperties).reduce(function (result, value, key) {
    key = cliOptionMap[key] || key;
    result[key] = value;
    return result;
  }, {});
  logger.debug('cli', cliOptions);
  logger.debug('options', options);
  const cli = new _eslint.default.CLIEngine(cliOptions);
  const watchDir = options._.length ? options._ : [_path.default.resolve('./')];
  const formatter = getFormatter(cli, options.format);

  function lintFile(path) {
    logger.debug('lintFile: %s', path);

    if (options.clear) {
      (0, _clearTerminal.default)();
    }

    const report = cli.executeOnFiles(path);

    if (options.fix) {
      _eslint.default.CLIEngine.outputFixes(report);
    }

    const results = _settings.default.cliOptions.quiet ? filterWarnings(report.results) : report.results;
    logger.log(formatter(results));
  }

  function isWatchableExtension(filePath, extensions) {
    logger.debug(filePath, extensions);

    if (extensions) {
      return _lodash.default.includes(extensions, _path.default.extname(filePath));
    } // Use the ESLint default extension, if none is provided


    return _lodash.default.includes(cli.options.extensions, _path.default.extname(filePath));
  }

  _chokidar.default.watch(watchDir, chokidarOptions).on(events.change, function changeEvent(path) {
    logger.debug('Changed:', path);

    if (!cli.isPathIgnored(path) && isWatchableExtension(path, options.ext)) {
      const watchPath = options.changed ? [path] : watchDir;
      lintFile(watchPath);
    }
  }).on('error', logger.error);

  logger.debug('Watching: %o', watchDir);
}

;
module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93YXRjaGVyLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImRlYnVnIiwiZXZlbnRzIiwiY2hhbmdlIiwiY2hva2lkYXJPcHRpb25zIiwiaWdub3JlZCIsImNsaU9wdGlvblByb3BlcnRpZXMiLCJjbGlPcHRpb25NYXAiLCJjb25maWciLCJlc2xpbnRyYyIsImV4dCIsImNhY2hlRmlsZSIsImZpbHRlcldhcm5pbmdzIiwicmVzdWx0cyIsIl8iLCJyZWR1Y2UiLCJjdXJyIiwicmVzdWx0Iiwid2FybmluZ0NvdW50IiwibmV3UmVzdWx0Iiwib21pdCIsIm1lc3NhZ2VzIiwiZmlsdGVyIiwibSIsInNldmVyaXR5IiwicHVzaCIsInJlcXVpcmVGb3JtYXR0ZXIiLCJmb3JtYXR0ZXJQYXRoIiwicmVxdWlyZSIsImV4IiwibWVzc2FnZSIsImdldEZvcm1hdHRlciIsImNsaSIsImZvcm1hdHRlciIsInBhdGhUb0Zvcm1hdHRlclNwZWNpZmllZCIsImluY2x1ZGVzIiwiaXNTaW1wbGVGb3JtYXR0ZXIiLCJyZXBsYWNlIiwiY3dkIiwicHJvY2VzcyIsImxvY2F0aW9uIiwicGF0aCIsInJlc29sdmUiLCJ3YXRjaGVyIiwib3B0aW9ucyIsImNsaU9wdGlvbnMiLCJwaWNrIiwidmFsdWUiLCJrZXkiLCJlc2xpbnQiLCJDTElFbmdpbmUiLCJ3YXRjaERpciIsImxlbmd0aCIsImZvcm1hdCIsImxpbnRGaWxlIiwiY2xlYXIiLCJyZXBvcnQiLCJleGVjdXRlT25GaWxlcyIsImZpeCIsIm91dHB1dEZpeGVzIiwic2V0dGluZ3MiLCJxdWlldCIsImxvZyIsImlzV2F0Y2hhYmxlRXh0ZW5zaW9uIiwiZmlsZVBhdGgiLCJleHRlbnNpb25zIiwiZXh0bmFtZSIsImNob2tpZGFyIiwid2F0Y2giLCJvbiIsImNoYW5nZUV2ZW50IiwiaXNQYXRoSWdub3JlZCIsIndhdGNoUGF0aCIsImNoYW5nZWQiLCJlcnJvciJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNB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LEVBQWdCO0FBQ2QsYUFBT25ELGdCQUFFcUIsUUFBRixDQUFXOEIsVUFBWCxFQUF1QnhCLGNBQUt5QixPQUFMLENBQWFGLFFBQWIsQ0FBdkIsQ0FBUDtBQUNELEtBSmlELENBTWxEOzs7QUFDQSxXQUFPbEQsZ0JBQUVxQixRQUFGLENBQVdILElBQUlZLE9BQUosQ0FBWXFCLFVBQXZCLEVBQW1DeEIsY0FBS3lCLE9BQUwsQ0FBYUYsUUFBYixDQUFuQyxDQUFQO0FBQ0Q7O0FBRURHLG9CQUFTQyxLQUFULENBQWVqQixRQUFmLEVBQXlCL0MsZUFBekIsRUFDR2lFLEVBREgsQ0FDTW5FLE9BQU9DLE1BRGIsRUFDcUIsU0FBU21FLFdBQVQsQ0FBcUI3QixJQUFyQixFQUEyQjtBQUM1Q3pDLFdBQU9DLEtBQVAsQ0FBYSxVQUFiLEVBQXlCd0MsSUFBekI7O0FBQ0EsUUFBSSxDQUFDVCxJQUFJdUMsYUFBSixDQUFrQjlCLElBQWxCLENBQUQsSUFBNEJzQixxQkFBcUJ0QixJQUFyQixFQUEyQkcsUUFBUWxDLEdBQW5DLENBQWhDLEVBQXlFO0FBQ3ZFLFlBQU04RCxZQUFZNUIsUUFBUTZCLE9BQVIsR0FDZCxDQUFDaEMsSUFBRCxDQURjLEdBRWRVLFFBRko7QUFJQUcsZUFBU2tCLFNBQVQ7QUFDRDtBQUNGLEdBVkgsRUFVS0gsRUFWTCxDQVVRLE9BVlIsRUFVaUJyRSxPQUFPMEUsS0FWeEI7O0FBWUExRSxTQUFPQyxLQUFQLENBQWEsY0FBYixFQUE2QmtELFFBQTdCO0FBQ0Q7O0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hva2lkYXIgZnJvbSAnY2hva2lkYXInO1xuaW1wb3J0IGVzbGludCBmcm9tICdlc2xpbnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgc2V0dGluZ3MgZnJvbSAnLi9zZXR0aW5ncyc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBjbGVhclRlcm1pbmFsIGZyb20gJy4vZm9ybWF0dGVycy9oZWxwZXJzL2NsZWFyLXRlcm1pbmFsLmpzJztcblxuY29uc3QgbG9nZ2VyID0gTG9nZ2VyKCd3YXRjaGVyJyk7XG5cbmxvZ2dlci5kZWJ1ZygnTG9hZGVkJyk7XG5cbmNvbnN0IGV2ZW50cyA9IHsgY2hhbmdlOiAnY2hhbmdlJyB9O1xuY29uc3QgY2hva2lkYXJPcHRpb25zID0ge1xuICBpZ25vcmVkOiAvXFwuZ2l0fG5vZGVfbW9kdWxlc3xib3dlcl9jb21wb25lbnRzL1xufTtcbmNvbnN0IGNsaU9wdGlvblByb3BlcnRpZXMgPSBbXG4gICdjb25maWcnLCAnZXNsaW50cmMnLCAnZXh0JyxcbiAgJ3BhcnNlcicsICdjYWNoZScsICdjYWNoZUxvY2F0aW9uJyxcbiAgJ2lnbm9yZScsICdpZ25vcmVQYXRoJywgJ2lnbm9yZVBhdHRlcm4nLFxuICAnZml4JywgJ3BhcnNlck9wdGlvbnMnLCAnZ2xvYmFsJ1xuXTtcbmNvbnN0IGNsaU9wdGlvbk1hcCA9IHtcbiAgY29uZmlnOiAnY29uZmlnRmlsZScsXG4gIGVzbGludHJjOiAndXNlRXNsaW50cmMnLFxuICBleHQ6ICdleHRlbnNpb25zJyxcbiAgY2FjaGVGaWxlOiAnY2FjaGVMb2NhdGlvbidcbn07XG5cbmZ1bmN0aW9uIGZpbHRlcldhcm5pbmdzKHJlc3VsdHMpIHtcbiAgcmV0dXJuIF8ucmVkdWNlKHJlc3VsdHMsIChjdXJyLCByZXN1bHQpID0+e1xuICAgIGlmIChyZXN1bHQud2FybmluZ0NvdW50KSB7XG4gICAgICBsZXQgbmV3UmVzdWx0ID0gXy5vbWl0KHJlc3VsdCwgJ21lc3NhZ2VzJyk7XG4gICAgICBuZXdSZXN1bHQubWVzc2FnZXMgPSBfLmZpbHRlcihyZXN1bHQubWVzc2FnZXMsIChtKSA9PiBtLnNldmVyaXR5ID4gMSk7XG4gICAgICBjdXJyLnB1c2gobmV3UmVzdWx0KTtcbiAgICAgIHJldHVybiBjdXJyO1xuICAgIH1cbiAgICBjdXJyLnB1c2gocmVzdWx0KTtcbiAgICByZXR1cm4gY3VycjtcbiAgfSwgW10pO1xufVxuXG5mdW5jdGlvbiByZXF1aXJlRm9ybWF0dGVyKGZvcm1hdHRlclBhdGgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gcmVxdWlyZShmb3JtYXR0ZXJQYXRoKTtcbiAgfSBjYXRjaCAoZXgpIHtcbiAgICBleC5tZXNzYWdlID0gYFRoZXJlIHdhcyBhIHByb2JsZW0gbG9hZGluZyBmb3JtYXR0ZXI6ICR7Zm9ybWF0dGVyUGF0aH1cXG5FcnJvcjogJHtleC5tZXNzYWdlfWA7XG4gICAgdGhyb3cgZXg7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0Rm9ybWF0dGVyKGNsaSwgZm9ybWF0dGVyKSB7XG4gIGNvbnN0IHBhdGhUb0Zvcm1hdHRlclNwZWNpZmllZCA9IGZvcm1hdHRlci5pbmNsdWRlcygnXFxcXCcpO1xuICBjb25zdCBpc1NpbXBsZUZvcm1hdHRlciA9IGZvcm1hdHRlci5pbmNsdWRlcygnc2ltcGxlJyk7XG4gIGNvbnN0IGZvcm1hdHRlclBhdGggPSBmb3JtYXR0ZXIucmVwbGFjZSgvXFxcXC9nLCAnLycpO1xuXG4gIGlmIChpc1NpbXBsZUZvcm1hdHRlcikge1xuICAgIGxvZ2dlci5kZWJ1ZyhgRm9ybWF0dGVyIGxvY2FsOiAkeyBmb3JtYXR0ZXIgfWApO1xuXG4gICAgcmV0dXJuIHJlcXVpcmVGb3JtYXR0ZXIoYC4vZm9ybWF0dGVycy8keyBmb3JtYXR0ZXJQYXRoIH1gKTtcbiAgfSBlbHNlIGlmIChwYXRoVG9Gb3JtYXR0ZXJTcGVjaWZpZWQpIHtcbiAgICBjb25zdCBjd2QgPSBwcm9jZXNzLmN3ZCgpO1xuXG4gICAgbG9nZ2VyLmRlYnVnKCdGb3JtYXR0ZXIgdXNlcjonLCBmb3JtYXR0ZXJQYXRoKTtcbiAgICBjb25zdCBsb2NhdGlvbiA9IHBhdGgucmVzb2x2ZShjd2QsIGZvcm1hdHRlclBhdGgpO1xuXG4gICAgcmV0dXJuIHJlcXVpcmVGb3JtYXR0ZXIobG9jYXRpb24pO1xuICB9XG5cbiAgbG9nZ2VyLmRlYnVnKGBGb3JtYXR0ZXIgZXNsaW50OiAkeyBmb3JtYXR0ZXIgfWApO1xuXG4gIHJldHVybiBjbGkuZ2V0Rm9ybWF0dGVyKGZvcm1hdHRlcik7XG5cbn1cblxuLy8vaHR0cHM6Ly9naXRodWIuY29tL2VzbGludC9lc2xpbnQvYmxvYi8yMzM0NDBlNTI0YWE0MTU0NWI2NmIyYzNjN2NhMjZmZTc5MGUzMmUwL3Rlc3RzL2xpYi9jbGktZW5naW5lLmpzI0wxMDUtTDEwN1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB3YXRjaGVyKG9wdGlvbnMpIHtcbiAgY29uc3QgY2xpT3B0aW9ucyA9IF8ob3B0aW9ucylcbiAgICAucGljayhjbGlPcHRpb25Qcm9wZXJ0aWVzKVxuICAgIC5yZWR1Y2UoZnVuY3Rpb24gKHJlc3VsdCwgdmFsdWUsIGtleSkge1xuICAgICAga2V5ID0gY2xpT3B0aW9uTWFwW2tleV0gfHwga2V5O1xuICAgICAgcmVzdWx0W2tleV0gPSB2YWx1ZTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSwge30pO1xuICBsb2dnZXIuZGVidWcoJ2NsaScsIGNsaU9wdGlvbnMpO1xuICBsb2dnZXIuZGVidWcoJ29wdGlvbnMnLCBvcHRpb25zKTtcbiAgY29uc3QgY2xpID0gbmV3IGVzbGludC5DTElFbmdpbmUoY2xpT3B0aW9ucyk7XG4gIGNvbnN0IHdhdGNoRGlyID0gb3B0aW9ucy5fLmxlbmd0aFxuICAgID8gb3B0aW9ucy5fXG4gICAgOiBbcGF0aC5yZXNvbHZlKCcuLycpXTtcblxuICBjb25zdCBmb3JtYXR0ZXIgPSBnZXRGb3JtYXR0ZXIoY2xpLCBvcHRpb25zLmZvcm1hdCk7XG5cbiAgZnVuY3Rpb24gbGludEZpbGUocGF0aCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnbGludEZpbGU6ICVzJywgcGF0aCk7XG4gICAgaWYgKG9wdGlvbnMuY2xlYXIpIHtcbiAgICAgIGNsZWFyVGVybWluYWwoKTtcbiAgICB9XG4gICAgY29uc3QgcmVwb3J0ID0gY2xpLmV4ZWN1dGVPbkZpbGVzKHBhdGgpO1xuICAgIGlmIChvcHRpb25zLmZpeCkge1xuICAgICAgZXNsaW50LkNMSUVuZ2luZS5vdXRwdXRGaXhlcyhyZXBvcnQpO1xuICAgIH1cbiAgICBjb25zdCByZXN1bHRzID0gc2V0dGluZ3MuY2xpT3B0aW9ucy5xdWlldFxuICAgICAgPyBmaWx0ZXJXYXJuaW5ncyhyZXBvcnQucmVzdWx0cylcbiAgICAgIDogcmVwb3J0LnJlc3VsdHM7XG5cbiAgICBsb2dnZXIubG9nKGZvcm1hdHRlcihyZXN1bHRzKSk7XG4gIH1cblxuICBmdW5jdGlvbiBpc1dhdGNoYWJsZUV4dGVuc2lvbihmaWxlUGF0aCwgZXh0ZW5zaW9ucykge1xuICAgIGxvZ2dlci5kZWJ1ZyhmaWxlUGF0aCwgZXh0ZW5zaW9ucyk7XG4gICAgaWYgKGV4dGVuc2lvbnMpIHtcbiAgICAgIHJldHVybiBfLmluY2x1ZGVzKGV4dGVuc2lvbnMsIHBhdGguZXh0bmFtZShmaWxlUGF0aCkpO1xuICAgIH1cblxuICAgIC8vIFVzZSB0aGUgRVNMaW50IGRlZmF1bHQgZXh0ZW5zaW9uLCBpZiBub25lIGlzIHByb3ZpZGVkXG4gICAgcmV0dXJuIF8uaW5jbHVkZXMoY2xpLm9wdGlvbnMuZXh0ZW5zaW9ucywgcGF0aC5leHRuYW1lKGZpbGVQYXRoKSk7XG4gIH1cblxuICBjaG9raWRhci53YXRjaCh3YXRjaERpciwgY2hva2lkYXJPcHRpb25zKVxuICAgIC5vbihldmVudHMuY2hhbmdlLCBmdW5jdGlvbiBjaGFuZ2VFdmVudChwYXRoKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NoYW5nZWQ6JywgcGF0aCk7XG4gICAgICBpZiAoIWNsaS5pc1BhdGhJZ25vcmVkKHBhdGgpICYmIGlzV2F0Y2hhYmxlRXh0ZW5zaW9uKHBhdGgsIG9wdGlvbnMuZXh0KSkge1xuICAgICAgICBjb25zdCB3YXRjaFBhdGggPSBvcHRpb25zLmNoYW5nZWRcbiAgICAgICAgICA/IFtwYXRoXVxuICAgICAgICAgIDogd2F0Y2hEaXI7XG5cbiAgICAgICAgbGludEZpbGUod2F0Y2hQYXRoKTtcbiAgICAgIH1cbiAgICB9KS5vbignZXJyb3InLCBsb2dnZXIuZXJyb3IpO1xuXG4gIGxvZ2dlci5kZWJ1ZygnV2F0Y2hpbmc6ICVvJywgd2F0Y2hEaXIpO1xufTtcbiJdfQ==